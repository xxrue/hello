<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saliran Baik dan Saliran Buruk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #0ea5e9 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        .nature-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, rgba(34, 197, 94, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #065f46 0%, #047857 30%, #0891b2 70%, #0284c7 100%);
        }
        
        .floating-leaves {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .leaf {
            position: absolute;
            font-size: 20px;
            animation: float 15s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes float {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .drag-item {
            transition: all 0.3s ease;
            cursor: grab;
        }
        
        .drag-item:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        
        .drop-zone {
            transition: all 0.3s ease;
            min-height: 120px;
        }
        
        .drop-zone.drag-over {
            background-color: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            transform: scale(1.02);
        }
        
        .correct-drop {
            animation: correctPulse 0.6s ease;
        }
        
        .wrong-drop {
            animation: wrongShake 0.6s ease;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: rgba(34, 197, 94, 0.3); }
            100% { transform: scale(1); }
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .celebration {
            animation: celebrate 1s ease;
        }
        
        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }
        
        .stage-indicator {
            transition: all 0.3s ease;
        }
        
        .stage-indicator.active {
            background-color: rgba(255, 255, 255, 0.9);
            color: #3b82f6;
            transform: scale(1.1);
        }
        
        .stage-indicator.completed {
            background-color: #22c55e;
            color: white;
        }
    </style>
</head>
<body class="p-4">
    <!-- Nature Background -->
    <div class="nature-bg"></div>
    <div class="floating-leaves" id="floating-leaves"></div>
    
    <div class="lg:flex lg:justify-center lg:mx-4 lg:min-h-screen lg:py-4 max-w-md mx-auto lg:max-w-none">
        <!-- Main Game Area -->
        <div class="lg:w-3/5 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10 lg:h-fit">
        <!-- Game Content Container -->
        <div id="game-content">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-700 p-6 text-center">
            <h1 class="text-2xl font-bold text-white mb-2">🌊 Saliran Baik dan Saliran Buruk 🌿</h1>
            
            <!-- Stage Progress -->
            <div class="flex justify-center items-center space-x-2 mb-3">
                <div id="stage-1" class="stage-indicator w-8 h-8 rounded-full bg-white bg-opacity-30 flex items-center justify-center text-white font-bold">1</div>
                <div class="w-6 h-1 bg-white bg-opacity-30 rounded"></div>
                <div id="stage-2" class="stage-indicator w-8 h-8 rounded-full bg-white bg-opacity-30 flex items-center justify-center text-white font-bold">2</div>
                <div class="w-6 h-1 bg-white bg-opacity-30 rounded"></div>
                <div id="stage-3" class="stage-indicator w-8 h-8 rounded-full bg-white bg-opacity-30 flex items-center justify-center text-white font-bold">3</div>
            </div>
            
            <div id="stage-title" class="text-lg font-semibold text-white mb-2">Tahap 1: Ciri-ciri</div>
            
            <div class="flex justify-center items-center space-x-4 text-white text-sm">
                <div class="flex items-center">
                    <span>🎯 Skor: </span>
                    <span id="score" class="font-bold ml-1">0</span>
                </div>
                <div class="flex items-center">
                    <span>⭐ Betul: </span>
                    <span id="correct" class="font-bold ml-1">0/6</span>
                </div>
                <div class="flex items-center">
                    <span>🏆 Tahap: </span>
                    <span id="current-stage" class="font-bold ml-1">1/3</span>
                </div>
            </div>
        </div>

        <!-- Game Instructions -->
        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400">
            <p class="text-sm text-yellow-800 font-medium">
                🎮 Seret item ke kawasan yang betul! Saliran baik atau saliran buruk?
            </p>
        </div>

        <!-- Drop Zones -->
        <div class="p-4 lg:p-6 space-y-4 lg:space-y-6">
            <!-- Good Drainage Zone -->
            <div id="good-drainage" class="drop-zone bg-green-50 border-2 border-dashed border-green-300 rounded-2xl p-4 lg:p-6">
                <div class="text-center mb-3 lg:mb-4">
                    <h3 class="text-lg lg:text-xl font-bold text-green-700 flex items-center justify-center">
                        🏔️ Saliran Baik
                    </h3>
                    <p class="text-xs lg:text-sm text-green-600 mt-1">Kawasan tidak bertakung air</p>
                </div>
                <div id="good-items" class="grid grid-cols-2 lg:grid-cols-3 gap-2 lg:gap-3 min-h-[60px] lg:min-h-[80px]"></div>
            </div>

            <!-- Poor Drainage Zone -->
            <div id="poor-drainage" class="drop-zone bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl p-4 lg:p-6">
                <div class="text-center mb-3 lg:mb-4">
                    <h3 class="text-lg lg:text-xl font-bold text-blue-700 flex items-center justify-center">
                        🌊 Saliran Buruk
                    </h3>
                    <p class="text-xs lg:text-sm text-blue-600 mt-1">Kawasan rendah bertakung air</p>
                </div>
                <div id="poor-items" class="grid grid-cols-2 lg:grid-cols-3 gap-2 lg:gap-3 min-h-[60px] lg:min-h-[80px]"></div>
            </div>
        </div>

        <!-- Items to Drag -->
        <div class="p-4 lg:p-6">
            <h4 class="text-lg lg:text-xl font-bold text-gray-700 mb-3 lg:mb-4 text-center">📦 Seret Item Ini:</h4>
            <div id="items-container" class="grid grid-cols-2 lg:grid-cols-3 gap-3 lg:gap-4"></div>
        </div>

        <!-- Action Buttons -->
        <div class="p-4 space-y-3">
            <button id="check-answers-btn" class="hidden w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-6 rounded-2xl shadow-lg transform transition hover:scale-105">
                ✅ Semak Jawapan
            </button>
        </div>

        <!-- Stage Completion Message -->
        <div id="stage-completion" class="hidden p-6 bg-gradient-to-r from-green-400 to-blue-500 text-center">
            <div class="text-4xl mb-2">⭐</div>
            <h3 class="text-xl font-bold text-white mb-2">Tahap Selesai!</h3>
            <p id="stage-completion-text" class="text-white mb-4">Bagus! Anda telah menguasai ciri-ciri saliran!</p>
            <div class="space-y-3">
                <button id="next-stage-btn" class="w-full bg-white text-blue-600 font-bold py-2 px-6 rounded-xl shadow-lg">
                    Seterusnya ➡️
                </button>
                <button id="reset-btn" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    🔄 Mula Semula Tahap
                </button>
            </div>
        </div>

        <!-- Result Message -->
        <div id="result-message" class="hidden p-4"></div>

        <!-- Game Completion Message -->
        <div id="game-completion" class="hidden p-6 bg-gradient-to-r from-emerald-400 to-teal-500 text-center">
            <div class="text-4xl mb-2">🎉</div>
            <h3 class="text-xl font-bold text-white mb-2">Tahniah!</h3>
            <p class="text-white mb-4">Anda telah berjaya menyelesaikan semua tahap!</p>
            <div class="text-white text-sm">
                <p>✅ Ciri-ciri Saliran</p>
                <p>✅ Tumbuh-tumbuhan</p>
                <p>✅ Hidupan Liar</p>
            </div>
            <button id="show-achievements-btn" class="mt-4 bg-white text-emerald-600 font-bold py-2 px-6 rounded-xl shadow-lg">
                🏆 Lihat Pencapaian
            </button>
        </div>
        </div>

        <!-- Achievement Screen -->
        <div id="achievement-screen" class="hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 p-6 text-center">
                <div class="text-6xl mb-2">🏆</div>
                <h2 class="text-2xl font-bold text-white mb-2">PENCAPAIAN ANDA</h2>
                <div class="text-white text-sm">Pakar Saliran Malaysia!</div>
            </div>
            
            <div class="p-6 lg:p-8 space-y-4 lg:space-y-6">
                <!-- Final Score -->
                <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 lg:p-6 rounded-xl text-center">
                    <div class="text-3xl lg:text-4xl font-bold text-purple-700" id="final-score">0</div>
                    <div class="text-purple-600 font-semibold lg:text-lg">Jumlah Skor</div>
                </div>
                
                <!-- Achievements Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                    <div class="bg-green-50 p-3 lg:p-4 rounded-xl text-center border-2 border-green-200">
                        <div class="text-2xl lg:text-3xl mb-1">🌿</div>
                        <div class="text-xs lg:text-sm font-bold text-green-700">Pakar Ciri-ciri</div>
                        <div class="text-xs lg:text-sm text-green-600" id="stage1-score">0/60</div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 lg:p-4 rounded-xl text-center border-2 border-blue-200">
                        <div class="text-2xl lg:text-3xl mb-1">🌳</div>
                        <div class="text-xs lg:text-sm font-bold text-blue-700">Ahli Botani</div>
                        <div class="text-xs lg:text-sm text-blue-600" id="stage2-score">0/60</div>
                    </div>
                    
                    <div class="bg-yellow-50 p-3 lg:p-4 rounded-xl text-center border-2 border-yellow-200">
                        <div class="text-2xl lg:text-3xl mb-1">🦌</div>
                        <div class="text-xs lg:text-sm font-bold text-yellow-700">Pakar Fauna</div>
                        <div class="text-xs lg:text-sm text-yellow-600" id="stage3-score">0/60</div>
                    </div>
                    
                    <div class="bg-purple-50 p-3 lg:p-4 rounded-xl text-center border-2 border-purple-200">
                        <div class="text-2xl lg:text-3xl mb-1">⚡</div>
                        <div class="text-xs lg:text-sm font-bold text-purple-700">Pantas</div>
                        <div class="text-xs lg:text-sm text-purple-600" id="speed-bonus">+0</div>
                    </div>
                </div>
                
                <!-- Performance Stats -->
                <div class="bg-gray-50 p-4 lg:p-6 rounded-xl">
                    <h4 class="font-bold text-gray-700 mb-3 lg:mb-4 text-center lg:text-lg">📊 Statistik Prestasi</h4>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-2 lg:gap-4">
                        <div class="flex lg:flex-col justify-between lg:justify-center text-sm lg:text-center lg:bg-white lg:p-3 lg:rounded-lg">
                            <span class="text-gray-600 lg:text-xs">Ketepatan Keseluruhan:</span>
                            <span class="font-bold text-green-600 lg:text-lg lg:mt-1" id="overall-accuracy">0%</span>
                        </div>
                        <div class="flex lg:flex-col justify-between lg:justify-center text-sm lg:text-center lg:bg-white lg:p-3 lg:rounded-lg">
                            <span class="text-gray-600 lg:text-xs">Masa Bermain:</span>
                            <span class="font-bold text-blue-600 lg:text-lg lg:mt-1" id="play-time">0 minit</span>
                        </div>
                        <div class="flex lg:flex-col justify-between lg:justify-center text-sm lg:text-center lg:bg-white lg:p-3 lg:rounded-lg">
                            <span class="text-gray-600 lg:text-xs">Tahap Diselesaikan:</span>
                            <span class="font-bold text-purple-600 lg:text-lg lg:mt-1">3/3</span>
                        </div>
                    </div>
                </div>
                
                <!-- Badges -->
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl">
                    <h4 class="font-bold text-orange-700 mb-3 text-center">🎖️ Lencana Khas</h4>
                    <div class="flex justify-center space-x-2" id="badges-container">
                        <!-- Badges will be added dynamically -->
                    </div>
                </div>
                
                <!-- Learning Summary -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 lg:p-6 rounded-xl border-2 border-green-200">
                    <h4 class="font-bold text-green-700 mb-4 text-center lg:text-lg">📚 Apa Yang Anda Pelajari</h4>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded-xl border-l-4 border-green-400">
                            <h5 class="font-bold text-green-700 mb-2">🏔️ Saliran Baik</h5>
                            <ul class="text-sm text-green-600 space-y-1">
                                <li>• Kawasan tidak bertakung air</li>
                                <li>• Terdapat di kawasan beralun</li>
                                <li>• Tanah yang subur</li>
                                <li>• Sesuai untuk pertanian</li>
                                <li>• Hutan tropika & monsun</li>
                                <li>• Habitat rusa, harimau, gajah</li>
                            </ul>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-400">
                            <h5 class="font-bold text-blue-700 mb-2">🌊 Saliran Buruk</h5>
                            <ul class="text-sm text-blue-600 space-y-1">
                                <li>• Kawasan rendah bertakung air</li>
                                <li>• Membentuk paya air tawar/masin</li>
                                <li>• Tumbuhan khas air banyak</li>
                                <li>• Pokok bakau & nipah</li>
                                <li>• Habitat hidupan liar akuatik</li>
                                <li>• Biawak, buaya, ular</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-400">
                        <h5 class="font-bold text-yellow-700 mb-2">💡 Kesimpulan</h5>
                        <p class="text-sm text-yellow-600">
                            Saliran mempengaruhi jenis tumbuhan dan haiwan yang boleh hidup di sesuatu kawasan. 
                            Kawasan saliran baik sesuai untuk pertanian, manakala kawasan saliran buruk menjadi habitat unik untuk spesies akuatik.
                        </p>
                    </div>
                </div>
                
                <!-- Action Button -->
                <div class="text-center">
                    <button id="play-again-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg">
                        🔄 Main Semula
                    </button>
                </div>
            </div>
        </div>
        </div>
        

    </div>
    </div>

    <script>
        const gameStages = {
            1: {
                title: "Tahap 1: Ciri-ciri",
                emoji: "🏔️",
                completionText: "Bagus! Anda telah menguasai ciri-ciri saliran!",
                tip: "Fikirkan tentang bentuk muka bumi. Kawasan tinggi atau rendah? Air mengalir atau bertakung?",
                items: [
                    { text: "Kawasan beralun", emoji: "🏔️", category: "good" },
                    { text: "Tanah pamah", emoji: "🌾", category: "good" },
                    { text: "Kawasan subur", emoji: "🌱", category: "good" },
                    { text: "Kawasan rendah", emoji: "⬇️", category: "poor" },
                    { text: "Paya air tawar", emoji: "🏞️", category: "poor" },
                    { text: "Paya air masin", emoji: "🌊", category: "poor" }
                ]
            },
            2: {
                title: "Tahap 2: Tumbuh-tumbuhan",
                emoji: "🌳",
                completionText: "Hebat! Anda faham tentang tumbuhan di kawasan saliran!",
                tip: "Tumbuhan mana yang suka tanah kering? Mana yang tumbuh di kawasan berair?",
                items: [
                    { text: "Hutan Tropika", emoji: "🌳", category: "good" },
                    { text: "Hutan Monsun", emoji: "🌲", category: "good" },
                    { text: "Hutan Konifer", emoji: "🌲", category: "good" },
                    { text: "Pokok Bakau", emoji: "🌿", category: "poor" },
                    { text: "Pokok Nipah", emoji: "🌴", category: "poor" },
                    { text: "Mengkuang", emoji: "🌾", category: "poor" }
                ]
            },
            3: {
                title: "Tahap 3: Hidupan Liar",
                emoji: "🦌",
                completionText: "Cemerlang! Anda telah menguasai hidupan liar!",
                tip: "Haiwan mana yang hidup di darat kering? Mana yang suka kawasan berair dan paya?",
                items: [
                    { text: "Rusa", emoji: "🦌", category: "good" },
                    { text: "Harimau", emoji: "🐅", category: "good" },
                    { text: "Gajah", emoji: "🐘", category: "good" },
                    { text: "Biawak", emoji: "🦎", category: "poor" },
                    { text: "Buaya", emoji: "🐊", category: "poor" },
                    { text: "Ular", emoji: "🐍", category: "poor" }
                ]
            }
        };

        let currentStage = 1;
        let score = 0;
        let correctAnswers = 0;
        let draggedElement = null;
        let stageScore = 0;
        let gameStartTime = Date.now();
        let stageStartTime = Date.now();
        let stageScores = { 1: 0, 2: 0, 3: 0 };
        let totalCorrect = 0;
        let totalAttempts = 0; // Track all attempts made
        let totalQuestions = 18; // 6 questions per stage × 3 stages
        
        // Load saved stats
        let gameStats = JSON.parse(localStorage.getItem('drainageGameStats') || '{"highScore": 0, "bestAccuracy": 0, "gamesCompleted": 0}');

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function createDragItem(item, index) {
            const div = document.createElement('div');
            div.className = 'drag-item bg-white rounded-xl p-3 shadow-md border-2 border-gray-200 text-center touch-manipulation';
            div.draggable = true;
            div.dataset.category = item.category;
            div.dataset.index = index;
            div.innerHTML = `
                <div class="text-2xl mb-1">${item.emoji}</div>
                <div class="text-xs font-semibold text-gray-700">${item.text}</div>
            `;

            // Touch events for mobile
            div.addEventListener('touchstart', handleTouchStart, { passive: false });
            div.addEventListener('touchmove', handleTouchMove, { passive: false });
            div.addEventListener('touchend', handleTouchEnd, { passive: false });

            // Drag events for desktop
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);

            return div;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            draggedElement = e.target.closest('.drag-item');
            draggedElement.style.opacity = '0.7';
            draggedElement.style.transform = 'scale(1.05)';
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!draggedElement) return;

            const touch = e.touches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropZone = elementBelow?.closest('.drop-zone');

            // Remove previous drag-over effects
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });

            if (dropZone) {
                dropZone.classList.add('drag-over');
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            if (!draggedElement) return;

            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropZone = elementBelow?.closest('.drop-zone');

            draggedElement.style.opacity = '1';
            draggedElement.style.transform = 'scale(1)';

            // Remove drag-over effects
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });

            if (dropZone) {
                handleDrop(dropZone, draggedElement);
            }

            draggedElement = null;
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.style.opacity = '0.7';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedElement = null;
        }

        function handleDrop(dropZone, item) {
            // Just move the item to the drop zone without checking correctness
            const targetContainer = dropZone.id === 'good-drainage' ? 
                document.getElementById('good-items') : 
                document.getElementById('poor-items');
            
            targetContainer.appendChild(item);
            item.draggable = true; // Keep draggable so they can move it again
            
            // Check if all items have been placed
            checkAllItemsPlaced();
        }
        
        function checkAllItemsPlaced() {
            const itemsContainer = document.getElementById('items-container');
            const remainingItems = itemsContainer.children.length;
            
            if (remainingItems === 0) {
                // All items placed, show check answers button
                const checkBtn = document.getElementById('check-answers-btn');
                checkBtn.classList.remove('hidden');
                checkBtn.classList.add('animate-pulse');
            }
        }
        
        function checkAnswers() {
            const goodItems = document.getElementById('good-items').children;
            const poorItems = document.getElementById('poor-items').children;
            
            let correct = 0;
            let total = 6;
            
            // Check good drainage items
            for (let item of goodItems) {
                if (item.dataset.category === 'good') {
                    item.classList.add('correct-drop');
                    correct++;
                } else {
                    item.classList.add('wrong-drop');
                }
            }
            
            // Check poor drainage items
            for (let item of poorItems) {
                if (item.dataset.category === 'poor') {
                    item.classList.add('correct-drop');
                    correct++;
                } else {
                    item.classList.add('wrong-drop');
                }
            }
            
            // Disable dragging after checking answers
            const allItems = document.querySelectorAll('.drag-item');
            allItems.forEach(item => {
                item.draggable = false;
                item.style.cursor = 'default';
                item.classList.add('pointer-events-none');
            });
            
            // Update score and show results
            correctAnswers = correct;
            const stagePoints = correct * 10;
            
            // Speed bonus calculation
            const timeElapsed = (Date.now() - stageStartTime) / 1000; // in seconds
            let speedBonus = 0;
            if (timeElapsed < 30 && correct === total) speedBonus = 20; // Perfect + Fast
            else if (timeElapsed < 60 && correct === total) speedBonus = 10; // Perfect + Normal
            else if (timeElapsed < 30) speedBonus = 5; // Just fast
            
            stageScores[currentStage] = stagePoints + speedBonus;
            score += stagePoints + speedBonus;
            totalCorrect += correct;
            totalAttempts += total; // Add 6 to total attempts each time we check answers
            
            updateScore();
            
            // Show result message
            const resultDiv = document.getElementById('result-message');
            const percentage = Math.round((correct / total) * 100);
            
            if (correct === total) {
                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 p-4 rounded-xl">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">🎉</div>
                            <div>
                                <h4 class="text-green-800 font-bold">Sempurna!</h4>
                                <p class="text-green-700 text-sm">Anda betul semua ${correct}/${total} jawapan!</p>
                            </div>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    if (currentStage === 3) {
                        // Game completed - update stats
                        const finalAccuracy = Math.round((totalCorrect / totalAttempts) * 100);
                        gameStats.gamesCompleted++;
                        if (score > gameStats.highScore) gameStats.highScore = score;
                        if (finalAccuracy > gameStats.bestAccuracy) gameStats.bestAccuracy = finalAccuracy;
                        localStorage.setItem('drainageGameStats', JSON.stringify(gameStats));
                        
                        document.getElementById('game-completion').classList.remove('hidden');
                        updateStageIndicator(currentStage, 'completed');
                    } else {
                        document.getElementById('stage-completion-text').textContent = gameStages[currentStage].completionText;
                        document.getElementById('stage-completion').classList.remove('hidden');
                        updateStageIndicator(currentStage, 'completed');
                    }
                }, 800);
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded-xl">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">📝</div>
                            <div>
                                <h4 class="text-yellow-800 font-bold">Hampir betul!</h4>
                                <p class="text-yellow-700 text-sm">Anda betul ${correct}/${total} jawapan (${percentage}%)</p>
                                <p class="text-yellow-600 text-xs mt-1">Cuba semula untuk jawapan yang lebih baik!</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show stage completion buttons for wrong answers too
                setTimeout(() => {
                    document.getElementById('stage-completion-text').textContent = `Anda betul ${correct}/${total} jawapan. Cuba lagi atau teruskan!`;
                    document.getElementById('stage-completion').classList.remove('hidden');
                    updateStageIndicator(currentStage, 'completed');
                }, 800);
            }
            
            resultDiv.classList.remove('hidden');
            document.getElementById('check-answers-btn').classList.add('hidden');
            document.getElementById('check-answers-btn').classList.remove('animate-pulse');
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('correct').textContent = `${correctAnswers}/6`;
            document.getElementById('current-stage').textContent = `${currentStage}/3`;
        }



        function updateStageIndicator(stage, status) {
            const indicator = document.getElementById(`stage-${stage}`);
            indicator.classList.remove('active', 'completed');
            if (status) {
                indicator.classList.add(status);
            }
        }

        function showAchievementScreen() {
            // Calculate final stats
            const playTime = Math.max(1, Math.round((Date.now() - gameStartTime) / 60000)); // in minutes, minimum 1
            const finalAccuracy = Math.min(100, Math.round((totalCorrect / totalAttempts) * 100)); // Based on all attempts made
            const speedBonus = Object.values(stageScores).reduce((sum, score) => sum + Math.max(0, score - 60), 0);
            
            console.log('Achievement Screen Data:', {
                score,
                stageScores,
                totalCorrect,
                totalQuestions,
                finalAccuracy,
                speedBonus,
                playTime
            });
            
            // Update achievement screen
            document.getElementById('final-score').textContent = score;
            document.getElementById('stage1-score').textContent = `${stageScores[1] || 0}/80`;
            document.getElementById('stage2-score').textContent = `${stageScores[2] || 0}/80`;
            document.getElementById('stage3-score').textContent = `${stageScores[3] || 0}/80`;
            document.getElementById('speed-bonus').textContent = `+${speedBonus}`;
            document.getElementById('overall-accuracy').textContent = `${finalAccuracy}%`;
            document.getElementById('play-time').textContent = `${playTime} minit`;
            
            // Generate badges
            const badgesContainer = document.getElementById('badges-container');
            badgesContainer.innerHTML = '';
            
            const badges = [];
            if (finalAccuracy === 100) badges.push({ emoji: '🎯', title: 'Sempurna!' });
            if (finalAccuracy >= 90) badges.push({ emoji: '⭐', title: 'Cemerlang' });
            if (finalAccuracy >= 80) badges.push({ emoji: '🌟', title: 'Bagus' });
            if (speedBonus > 30) badges.push({ emoji: '⚡', title: 'Kilat' });
            if (playTime <= 5) badges.push({ emoji: '🚀', title: 'Pantas' });
            if (score >= 200) badges.push({ emoji: '👑', title: 'Raja Saliran' });
            if (score >= 150) badges.push({ emoji: '🏆', title: 'Juara' });
            if (badges.length === 0) badges.push({ emoji: '🎉', title: 'Tamat!' });
            
            badges.forEach(badge => {
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'text-center p-2 bg-yellow-100 rounded-lg border-2 border-yellow-300';
                badgeDiv.innerHTML = `
                    <div class="text-lg">${badge.emoji}</div>
                    <div class="text-xs font-bold text-yellow-700">${badge.title}</div>
                `;
                badgesContainer.appendChild(badgeDiv);
            });
            
            // Hide game content and show achievement screen
            document.getElementById('game-content').classList.add('hidden');
            document.getElementById('achievement-screen').classList.remove('hidden');
        }

        function loadStage(stageNumber) {
            currentStage = stageNumber;
            const stage = gameStages[currentStage];
            stageStartTime = Date.now();
            
            // Update UI
            document.getElementById('stage-title').textContent = stage.title;
            
            // Update stage indicators
            for (let i = 1; i <= 3; i++) {
                updateStageIndicator(i, i < currentStage ? 'completed' : (i === currentStage ? 'active' : ''));
            }
            
            // Load stage items
            const container = document.getElementById('items-container');
            const shuffledItems = shuffleArray(stage.items);
            
            container.innerHTML = '';
            document.getElementById('good-items').innerHTML = '';
            document.getElementById('poor-items').innerHTML = '';
            
            shuffledItems.forEach((item, index) => {
                container.appendChild(createDragItem(item, index));
            });

            correctAnswers = 0;
            updateScore();
            
            // Hide all messages and buttons
            document.getElementById('stage-completion').classList.add('hidden');
            document.getElementById('game-completion').classList.add('hidden');
            document.getElementById('result-message').classList.add('hidden');
            document.getElementById('check-answers-btn').classList.add('hidden');
            document.getElementById('check-answers-btn').classList.remove('animate-pulse');
            
            // Remove any previous styling
            const allItems = document.querySelectorAll('.drag-item');
            allItems.forEach(item => {
                item.classList.remove('correct-drop', 'wrong-drop');
            });
        }
        


        function nextStage() {
            if (currentStage < 3) {
                loadStage(currentStage + 1);
            }
        }

        function initializeGame() {
            currentStage = 1;
            score = 0;
            totalCorrect = 0;
            totalAttempts = 0;
            stageScores = { 1: 0, 2: 0, 3: 0 };
            gameStartTime = Date.now();
            
            // Show game content and hide achievement screen
            document.getElementById('game-content').classList.remove('hidden');
            document.getElementById('achievement-screen').classList.add('hidden');
            
            loadStage(1);
        }

        // Setup drop zones
        function setupDropZones() {
            const dropZones = document.querySelectorAll('.drop-zone');
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });
                
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    if (draggedElement) {
                        handleDrop(zone, draggedElement);
                    }
                });
            });
        }

        // Create floating leaves animation
        function createFloatingLeaves() {
            const leavesContainer = document.getElementById('floating-leaves');
            const leaves = ['🍃', '🌿', '🍀', '🌱'];
            
            setInterval(() => {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.textContent = leaves[Math.floor(Math.random() * leaves.length)];
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.animationDuration = (Math.random() * 10 + 10) + 's';
                leaf.style.animationDelay = Math.random() * 2 + 's';
                
                leavesContainer.appendChild(leaf);
                
                // Remove leaf after animation
                setTimeout(() => {
                    if (leaf.parentNode) {
                        leaf.parentNode.removeChild(leaf);
                    }
                }, 17000);
            }, 3000);
        }

        // Create floating leaves animation
        function createFloatingLeaves() {
            const leavesContainer = document.getElementById('floating-leaves');
            const leaves = ['🍃', '🌿', '🍀', '🌱'];
            
            setInterval(() => {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.textContent = leaves[Math.floor(Math.random() * leaves.length)];
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.animationDuration = (Math.random() * 10 + 10) + 's';
                leaf.style.animationDelay = Math.random() * 2 + 's';
                
                leavesContainer.appendChild(leaf);
                
                // Remove leaf after animation
                setTimeout(() => {
                    if (leaf.parentNode) {
                        leaf.parentNode.removeChild(leaf);
                    }
                }, 17000);
            }, 3000);
        }

        // Event listeners
        document.getElementById('reset-btn').addEventListener('click', () => loadStage(currentStage));
        document.getElementById('next-stage-btn').addEventListener('click', nextStage);
        document.getElementById('check-answers-btn').addEventListener('click', checkAnswers);
        document.getElementById('show-achievements-btn').addEventListener('click', showAchievementScreen);
        document.getElementById('play-again-btn').addEventListener('click', initializeGame);

        // Initialize game
        setupDropZones();
        initializeGame();
        createFloatingLeaves();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98419ebf04f4f004',t:'MTc1ODcwOTk3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
